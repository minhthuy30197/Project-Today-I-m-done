<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Today I'm done</title>
    <link rel="stylesheet" href="assests/css/style.css">
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <!-- jQuery library -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <!-- Latest compiled JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        .bg-blue {
            background-color: #9fcdff;
        }
    </style>
</head>
<body>
<nav class="navbar navbar-default" role="navigation" style="opacity:0.8 ">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="#"><span class="glyphicon glyphicon-check gi-2x"></span> <span class="text30">Today I'm done</span></a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse navbar-ex1-collapse">
        <ul class="nav navbar-nav navbar-right">
            <li><a href="#" data-toggle="modal" data-target="#modalSettings">
                    <span class="glyphicon glyphicon-cog gi-2x"></span></a></li>
            <li class="dropdown">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown"><span class="text20"></span><b
                            class="caret"></b></a>
                <ul class="dropdown-menu">
                    <li><a href="#" data-toggle="modal" data-target="#modalProfile"><span
                                    class="glyphicon glyphicon-pencil"></span> Change profile</a></li>
                    <li><a href="#"><span class="glyphicon glyphicon-log-out"></span> Log out</a></li>
                </ul>
            </li>
        </ul>
    </div><!-- /.navbar-collapse -->
</nav>
<br>
<br>
<div class="container">
    <div class="row text-center">
        <div class="col-md-6 col-md-push-3 col-xs-8 col-xs-push-2">
            <div class="clock">
                <img src="assests/images/Tomato1.png" alt="" class="img-responsive">
                <div class="time">
                    <div id="timer">
                        <span id="minutes">25</span>
                        <span id="colon">:</span>
                        <span id="seconds">00</span>
                    </div>
                    <div id="filler"></div>
                </div>
            </div>
            <br>
            <div id="buttons">
                <button class="btn btn-success radius btn-lg" id="work">Work</button>
                <button class="btn btn-warning radius btn-lg" id="restart">Restart</button>
            </div>
        </div>
    </div>
    <br>
    <br>
    <div class="row">
        <div class="tasks">
            <div class="col-lg-8 col-lg-push-2">
                <div class="well">
                    <div id="slogan"><span class="glyphicon glyphicon-th-list"></span> Make my day</div>
                    <br>
                    <div id="task-list">

                    </div>
                    <div class="form-inline">
                        <input type="text" id="newtask" placeholder="Input new task here..." class="form-control">
                        <button class="btn btn-success" id="addTask">Add</button>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- Modal -->
    <div class="modal fade" id="modalSettings" role="dialog">
        <div class="modal-dialog">
            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h2 class="modal-title"><b>Options</b></h2>
                </div>
                <div class="modal-body">
                    <h4><label for="ring">Select sound</label></h4><select class="form-control" id="ring">
                        <option>1</option>
                        <option>2</option>
                        <option>3</option>
                        <option>4</option>
                    </select>
                    <h4>Select volume <span class="glyphicon glyphicon-volume-up"></span></h4>
                    <div class="text-center">
                        <label class="radio-inline">
                            <input type="radio" name="optradio">25%
                        </label>
                        <label class="radio-inline">
                            <input type="radio" name="optradio">50%
                        </label>
                        <label class="radio-inline">
                            <input type="radio" name="optradio">75%
                        </label>
                        <label class="radio-inline">
                            <input type="radio" name="optradio">100%
                        </label>
                    </div>
                </div>
                <div class="modal-footer text-right">
                    <button class="btn btn-success" id="SaveSettings" type="submit">Save</button>
                    <button class="btn btn-default" id="ResetSettings" type="reset">Reset</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalProfile" role="dialog">
        <div class="modal-dialog">
            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h2 class="modal-title"><b>Profile</b></h2>
                </div>
                <div class="modal-body">
                    <div class="input-group">
                        <span class="input-group-addon">Full Name</span>
                        <input id="fullName" type="text" class="form-control" name="fullName"
                               placeholder="Your full name">
                    </div>
                    <br>
                    <div class="input-group">
                        <span class="input-group-addon">Email</span>
                        <input id="email" type="password" class="form-control" name="email"
                               placeholder="Your email">
                    </div>
                    <br>
                    <b>Change your password</b>
                    <div class="input-group">
                        <span class="input-group-addon">Your old password</span>
                        <input id="oldPassword" type="password" class="form-control" name="oldPassword"
                               placeholder="">
                    </div>
                    <br>
                    <div class="input-group">
                        <span class="input-group-addon">Your new password</span>
                        <input id="newPassword" type="text" class="form-control" name="newPassword"
                               placeholder="">
                    </div>
                    <br>
                    <div class="input-group">
                        <span class="input-group-addon">Retype new password</span>
                        <input id="retypePassword" type="password" class="form-control" name="retypePassword"
                               placeholder="">
                    </div>
                </div>
                <div class="modal-footer text-right">
                    <button class="btn btn-success" id="SaveProfile" type="submit">Save</button>
                    <button class="btn btn-default" id="ResetProfile" type="reset">Reset</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="myModal" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h2 class="modal-title"><b>Change your task</b></h2>
                </div>
                <div class="modal-body">
                    <div class="input-group">
                        <label for="task_id"></label><input type="text" hidden value="" id="task_id">
                        <span class="input-group-addon">Your task</span>
                        <input id="task_modal_name" type="text" class="form-control" name="Task" placeholder="">
                    </div>
                </div>
                <div class="modal-footer text-right">
                    <button class="btn btn-success" id="SaveTask" type="submit">Save your change</button>
                </div>
            </div>
        </div>
    </div>

</div>
</body>
</html>

<script>
  let pomodoro = {
    minutes: 0,
    seconds: 0,
    fillerHeight: 0,
    fillerIncrement: 0,
    interval: null,
    minutesDom: null,
    secondsDom: null,
    fillerDom: null,
    init: function () {
      let self = this
      this.minutesDom = document.querySelector('#minutes')
      this.secondsDom = document.querySelector('#seconds')
      this.fillerDom = document.querySelector('#filler')
      this.interval = setInterval(function () {
        self.intervalCallback.apply(self)
      }, 1000)
      document.querySelector('#work').onclick = function () {
        self.startWork.apply(self)
      }
      document.querySelector('#restart').onclick = function () {
        self.stopTimer.apply(self)
      }
    },
    resetVariables: function (mins, secs, started) {
      this.minutes = mins
      this.seconds = secs
      this.started = started
      this.fillerIncrement = 200 / (this.minutes * 60)
      this.fillerHeight = 0
    },
    startWork: function () {
      this.resetVariables(25, 0, true)
    },
    stopTimer: function () {
      this.resetVariables(25, 0, false)
      this.updateDom()
    },
    toDoubleDigit: function (num) {
      if (num < 10) {
        return '0' + parseInt(num, 10)
      }
      return num
    },
    updateDom: function () {
      this.minutesDom.innerHTML = this.toDoubleDigit(this.minutes)
      this.secondsDom.innerHTML = this.toDoubleDigit(this.seconds)
      this.fillerHeight = this.fillerHeight + this.fillerIncrement
      this.fillerDom.style.height = this.fillerHeight + 'px'
    },
    intervalCallback: function () {
      if (!this.started) return false
      if (this.seconds === 0) {
        if (this.minutes === 0) {
          this.timerComplete()
          return
        }
        this.seconds = 59
        this.minutes--
      } else {
        this.seconds--
      }
      this.updateDom()
    },
    timerComplete: function () {
      this.started = false
      this.fillerHeight = 0
    },
  }

  window.onload = function () {
    pomodoro.init()
    $.get('/gettask', (data) => {
      let arr = JSON.parse(data)
      let count = arr.tasks.length
      let i = 0
      while (i<count) {
        if (arr.tasks[i].done == true) $('#task-list').append(drawDoneTask(arr.tasks[i].id, arr.tasks[i].name))
        else $('#task-list').append(drawNotDoneTask(arr.tasks[i].id, arr.tasks[i].name))
        i++
      }
    })
  }

  function pomoClick () {
    pomodoro.init()
    pomodoro.startWork()
  }
</script>

<script>
  function fixBtn (id) {
    $.get('/task?id=' + id, (data) => {
      let obj = JSON.parse(data)
      $('#task_modal_name').val(obj.name)
      $('#task_id').val(obj.id)
      $('#myModal').modal()
    })
  }

  function deleteTask (id) {
    let obj = {'id': id}
    $.ajax({
      type: 'POST',
      url: '/delete',
      data: obj,
      dataType: 'json',
      success: function (result) {
        if (result['result'] === 'success') {
          $('#' + id).remove()
        }
      },
    })
  }

  function doneTask (id) {
    let obj = {'id': id}
    $.ajax({
      type: 'POST',
      url: '/done',
      data: obj,
      dataType: 'json',
      success: function (result) {
        if (result['result'] === 'success') {
          $('#'+id).replaceWith(drawDoneTask(id, result['name']))
        }
      },
    })
  }

  function resetTask (id) {
    let obj = {'id': id}
    $.ajax({
      type: 'POST',
      url: '/reset',
      data: obj,
      dataType: 'json',
      success: function (result) {
        if (result['result'] === 'success') {
          $('#'+id).replaceWith(drawNotDoneTask(id, result['name']))
        }
      },
    })
  }

  $('#addTask').click(function () {
    let name = $('#newtask').val()
    if (name === '') alert('Vui lòng nhập công việc!')
    else {
      let obj = {'name': name}
      $.ajax({
        type: 'POST',
        url: '/insert',
        data: obj,
        dataType: 'json',
        success: function (result) {
          if (result['result'] === 'success') {
            console.log(result['id'])
            $('#newtask').val('')
            $('#task-list').append(drawNotDoneTask(result['id'], name))
          }
        },
      })
    }
  })

  $('#SaveTask').click(function () {
    let id = $('#task_id').val()
    let name = $('#task_modal_name').val()
    let obj = {'name': name, 'id': id}
    console.log(JSON.stringify(obj))
    $.ajax({
      type: 'POST',
      url: '/changetask',
      data: obj,
      dataType: 'json',
      success: function (result) {
        if (result['result'] === 'success') {
          $('#content' + id).text(name)
          $('#myModal').modal('hide')
        }
      },
    })
  })

  function drawDoneTask (id, name) {
    return '<div class="thumbnail  pad10 bg-blue" id="'+id+'">\n' +
      '             <p>'+name+'</p>\n' +
      '             <div class="text-right" id="btngrp'+id+'">\n' +
      '                 <button class="btn glyphicon glyphicon-refresh" id="reset"\n' +
      '                     onclick="resetTask(\''+id+'\')"></button>\n' +
      '                 <button class="btn glyphicon glyphicon-trash" id="delete"\n' +
      '                     onclick="deleteTask(\''+id+'\')"></button>\n' +
      '             </div>\n' +
      '         </div>'
  }

  function drawNotDoneTask (id, name) {
        return "<div class='thumbnail  pad10' id='"+id+"'>\n" +
      "             <p id='content" + id + "'>" + name + "</p>\n" +
      "             <div class='text-right' id='btngrp" + id + "'>\n" +
      "                 <button class='btn glyphicon glyphicon-ok'\n" +
      "                     onclick=\"doneTask(\'"+ id +"\')\"></button>\n" +
      "                 <button class='btn glyphicon glyphicon-time '  onclick='pomoClick()'></button>\n" +
      "                 <button class='btn glyphicon glyphicon-pencil'\n" +
      "                     onclick=\"fixBtn(\'"+id+"\')\"></button>\n" +
      "                 <button class='btn glyphicon glyphicon-trash'\n" +
      "                     onclick=\"deleteTask(\'" + id + "\')\"></button>\n" +
      "              </div>\n" +
      "        </div>"
  }
</script>